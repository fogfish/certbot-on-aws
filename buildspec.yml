version: 0.1

phases:
  install:
    commands:
      - echo "==> install"
  pre_build:
    commands:
      - echo "==> pre-build"
      - aws s3 cp ${S3}/letsencrypt.tgz /tmp/letsencrypt.tgz && tar -C / -xvf /tmp/letsencrypt.tgz || echo "empty project"
      - |
        if [ `ls -1A /etc/letsencrypt | wc -l` -eq 0 ] ;
        then
          echo "==> register new account"
          certbot register --agree-tos --register-unsafely-without-email
        else
          echo "==> use existing account"
        fi
  build:
    commands:
      - echo "==> build"
      - |
        if [ ! -d "/etc/letsencrypt/archive/${FQDN}" ] ;
        then
          echo "==> request certificates for ${FQDN}"
          certbot certonly --staging --dns-route53 -d ${FQDN} --register-unsafely-without-email --agree-tos
        else
          echo "==> re-new of ${FQDN}"
          certbot renew --staging
        fi
  post_build:
    commands:
      - echo "==> post-build"
      - tar -czvf /tmp/letsencrypt.tgz /etc/letsencrypt
      - aws s3 cp /tmp/letsencrypt.tgz ${S3}/letsencrypt.tgz
